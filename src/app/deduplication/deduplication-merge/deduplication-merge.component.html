<div class="container">
  <div class="row">
    <div class="col-12">
      <h2 id="header" class="border-bottom pb-2">
        {{ "deduplication.merge.label.title" | translate }}
      </h2>

      <div class="col-md-12 text-center" *ngIf="!itemsToCompare">
        <ds-loading> </ds-loading>
      </div>

      <div class="col-md-12 text-center" *ngIf="itemsToCompare?.length == 0">
        <h4 class="p-3">
          {{ "deduplication.merge.message.no-data" | translate }}
        </h4>
      </div>

      <ng-container *ngIf="itemsToCompare && itemsToCompare.length > 0">
        <div class="col-md-12 text-center">
          <h5>{{ "deduplication.merge.label.info" | translate }}</h5>
        </div>

        <!-- Item Data Tabel -->
        <table class="table table-striped mb-4">
          <thead>
            <tr>
              <th scope="col">
                {{ "deduplication.merge.table.header.entities" | translate }}
              </th>
              <th scope="col">{{ "Handle" | translate }}</th>
              <th scope="col">
                {{ "deduplication.merge.table.header.identifier" | translate }}
              </th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let itemObj of itemsToCompare">
              <td>
                <span>
                  <strong>
                    {{
                    "deduplication.merge.table.header.title" | translate
                    }}:</strong>
                  {{ itemObj.object?.name }}</span>
                <br />
                <span *ngIf="(itemObj.object)?.metadata['dc.type']">
                  <strong>Type:</strong>
                  {{
                  (itemObj.object)?.metadata["dc.type"][0].value
                  }}</span>
                <br />
                <span>
                  <strong>Entity type:</strong>
                  {{ (itemObj.object)?.type }}</span>
                <br />
                <strong>Collection:</strong>
                <span>
                  {{ getOwningCollectionTitle(itemObj.object) | async }}</span>
              </td>
              <td>
                {{ (itemObj.object)?.handle }}
              </td>
              <td>
                <span [ngStyle]="{ color: itemObj.color }">
                  {{ (itemObj.object)?.uuid }}
                </span>
              </td>
            </tr>
          </tbody>
        </table>

        <div class="col-md-12 text-center border-top pt-2">
          <h5>{{ "deduplication.merge.label.bitstreams" | translate }}</h5>
        </div>
        <!-- Bitstream Data Tabel -->
        <table class="table table-striped">
          <thead>
            <tr>
              <th scope="col">
                {{ "Select" | translate }}
              </th>
              <th scope="col">
                {{
                "deduplication.merge.table.bitstream.header.title" | translate
                }}
              </th>
              <th scope="col">
                {{
                "deduplication.merge.table.bitstream.header.identifier"
                | translate
                }}
              </th>
              <th scope="col">
                {{
                "deduplication.merge.table.bitstream.header.item-identifier"
                | translate
                }}
              </th>
              <th scope="col">
                {{ "Actions" | translate }}
              </th>
            </tr>
          </thead>
          <tbody>
            <ng-container *ngFor="let itemObj of itemsToCompare">
              <ds-loading [showMessage]="false" *ngIf="!(itemObj.object | dsGetBitstreams | async | async)">
              </ds-loading>
              <tr *ngFor="
                  let bitstream of itemObj.object
                    | dsGetBitstreams
                    | async
                    | async
                ">
                <td>
                  <div class="custom-control custom-checkbox">
                    <input type="checkbox" class="custom-control-input" [id]="bitstream.uuid" [checked]="
                        bitstreamList.includes(bitstream._links.self.href)
                      " (change)="onBitstreamChecked($event, bitstream)" />
                    <label class="custom-control-label" [for]="bitstream.uuid"></label>
                  </div>
                </td>
                <td>
                  <span *ngFor="let title of bitstream.metadata['dc.title']">
                    {{ title.value }} <br />
                  </span>
                </td>
                <td>{{ bitstream.uuid }}<br /></td>
                <td>
                  <span [ngStyle]="{ color: itemObj.color }">
                    {{ (itemObj.object)?.uuid }}
                  </span>
                </td>
                <td>
                  <a> View</a>
                </td>
              </tr>
            </ng-container>
          </tbody>
        </table>

        <div class="justify-content-end pr-3 mb-1 row">
          <button *ngIf="!isExpanded" class="btn btn-secondary mr-1" (click)="expandAll()">
            <i class="fa fa-chevron-down pr-1" aria-hidden="true"></i>
            {{ "Expand All" }}
          </button>

          <button *ngIf="isExpanded" class="btn btn-secondary mr-1" (click)="collapseAll()">
            <i class="fa fa-chevron-up pr-1" aria-hidden="true"></i>
            {{ "Collapse All" }}
          </button>

          <button class="btn btn-info" (click)="merge()">
            <i class="fa fa-code pr-1" aria-hidden="true"></i>
            {{ "deduplication.merge.button.label.merge" | translate }}
          </button>
        </div>

        <ng-container *ngIf="compareMetadataValues.size > 0">
          <ngb-accordion #accordions [destroyOnHide]="false" [closeOthers]="false" activeIds="panel-0" *ngFor="
          let metadataKeyValues of compareMetadataValues | keyvalue;
          let kIdx = index
        ">
            <ngb-panel id="panel-{{ 0 }}">
              <ng-template ngbPanelHeader let-opened="opened">
                <div class="row">
                  <div class="col-md-9 mt-1 uppercase">
                    {{ metadataKeyValues.key }}
                  </div>

                  <div class="col-md-3 text-right mt-1">
                    <button *ngIf="metadataKeyValues.value.length > 1" class="btn btn-sm btn-warning mr-2"
                      (click)="showDiff(metadataKeyValues.key)">
                      {{
                      "deduplication.merge.button.label.show-diff" | translate
                      }}
                    </button>
                    <button ngbTooltip="Remove values for this metadata field" pacement="left" class="btn btn-sm btn-danger mr-2" (click)="removeValuesFromMerge(metadataKeyValues.key)">
                      <i class="fa fa-trash"></i>
                    </button>
                    <button ngbPanelToggle class="btn btn-sm" [ngClass]="opened ? 'btn-info' : 'btn-outline-info'">
                      <i *ngIf="!opened" class="fa fa-chevron-up"></i>
                      <i *ngIf="opened" class="fa fa-chevron-down"></i>
                    </button>
                  </div>
                </div>
              </ng-template>
              <ng-template ngbPanelContent>
                <ng-container *ngFor="
                    let itemsData of metadataKeyValues.value;
                    let last = last;
                    let itemIdx = index;
                  ">
                  <div class="row"
                    [ngClass]="{'heighlighted-selection': isValueChecked(metadataKeyValues.key, itemsData.items)}">

                    <!-- if more than one selection can occur-->
                    <div class="col-1" *ngIf="kIdx % 2 == 0">
                      <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input"
                          [checked]="isValueChecked(metadataKeyValues.key, itemsData.items)" [id]="
                        metadataKeyValues.key + itemsData.value + itemIdx" (change)="
                            onValueSelect(
                              metadataKeyValues.key,
                              itemsData.items,
                              'multiple'
                            )
                          " />
                        <label class="custom-control-label" [for]="
                        metadataKeyValues.key + itemsData.value + itemIdx "></label>
                      </div>
                    </div>

                    <!-- if only one selection can occur-->
                    <!-- TODO: depends on rest properties -->

                    <div class="col-1" *ngIf="kIdx % 2 != 0">
                      <div class="custom-control custom-radio">
                        <input class="custom-control-input" type="radio" [name]="metadataKeyValues.key" [id]="
                        metadataKeyValues.key +
                        itemsData.value +
                        itemIdx
                          " [value]="
                          itemsData.value + metadataKeyValues.key
                          " (change)="
                            onValueSelect(
                              metadataKeyValues.key,
                              itemsData.items,
                              'single'
                            )
                          " />
                        <label class="custom-control-label" [for]="
                        metadataKeyValues.key +
                        itemsData.value +
                        itemIdx
                          "></label>
                      </div>
                    </div>
                    <ng-container *ngIf="itemsData.items.length > 1;else manyValues">
                      <span class="col-6">
                        {{itemsData.value }}
                      </span>
                      <span class="col-5">
                        <ng-container *ngFor="let item of itemsData.items;let idx = index">
                          <span [ngStyle]="{ 'color': item.color }">
                            {{ item.itemId }}
                          </span>
                          <span *ngIf="idx !== itemsData.items.length-1 "> ,</span>
                        </ng-container>
                      </span>
                    </ng-container>
                    <ng-template #manyValues>
                      <span class="col-6">
                        {{itemsData.value }}
                      </span>
                      <span class="col-5" [ngStyle]="{ 'color': itemsData.items[0].color }">
                        {{itemsData.items[0].itemId }}
                      </span>
                    </ng-template>
                  </div>
                  <hr *ngIf="metadataKeyValues.value.length > 1 && !last ">
                </ng-container>
              </ng-template>
            </ngb-panel>
          </ngb-accordion>
        </ng-container>
      </ng-container>
    </div>
  </div>
</div>
